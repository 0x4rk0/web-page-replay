<html>
  <head>
  <title>Chromium Perf Tracker</title>
  <link rel="stylesheet" href="styles/style.css">
  <script src="scripts/util.js"></script>
  <script src="jst/util.js" type="text/javascript"></script>
  <script src="jst/jsevalcontext.js" type="text/javascript"></script>
  <script src="jst/jstemplate.js" type="text/javascript"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  </head>

  <body onLoad="main()">
    <h1><div id="header">Chromium Page Tracker</div></h1>

    <script>
    data = {};
    networks_map = {};   // maps from db.Key to pretty name.

    function loadFilters() {
      // Fetch data for the filters.
      var filter_data_url = "/json?type=filters";
      new XHRGet(filter_data_url, function(result) {
        data.filters = JSON.parse(result);
        var context = JsEvalContext.create(data.filters);
        var template = document.getElementById("filters_template");
        jstProcess(context, template);
        JsEvalContext.recycle(context);

        // Populate the networks list
        for (index in data.filters.networks) {
          networks_map[data.filters.networks[index][1]] =
              data.filters.networks[index][0];
        }

        var params = getParams();   // Load parameters from URL.
        if (!params["network1"]) {
          params["network1"] = data.filters.networks[0][1];
        }
        if (!params["network2"]) {
          params["network2"] = data.filters.networks[1][1];
        }
        if (!params["network3"]) {
          params["network3"] = data.filters.networks[2][1];
        }
        setParams(params);

        setSelectValue("networks_filter1", params["network1"]);
        setSelectValue("networks_filter2", params["network2"]);
        setSelectValue("networks_filter3", params["network3"]);
        loadData();
      });
    }

    function loadData() {
      var params = getParams();
      var url = ("/json?type=set_search&networks_filter=" +
                 params["network1"] + "," +
                 params["network2"] + "," +
                 params["network3"]);
      new XHRGet(url, function(result) {
        data.results = JSON.parse(result);
        drawChart(data.results);
      });
    }

    // See: http://code.google.com/apis/visualization/documentation/gallery/linechart.html
    google.load('visualization', '1', {'packages':['corechart']});

    function getVersionMap(results, network) {
      // Average all points for a given version into a single value.
      var versionMap = {};
      for (var i = 0; i < results.length; ++i) {
        if (!results[i].total_time) continue;
        if (results[i].network != network) continue;
        var point = versionMap[results[i].version] || { avg: 0, count: 0};
        point.avg = (point.avg * point.count + results[i].total_time) / ++point.count;
        versionMap[results[i].version] = point;
      }
      return versionMap;
    }

    function getId(type, name) {
      var items = data.filters[type];
      for (var i = items.length - 1; i >= 0; i--) {
        if (items[i][0] == name) return items[i][1];
      }
      return 0;
    }

    function drawChart(results) {
      var graph_data = new google.visualization.DataTable();

      graph_data.addColumn('string', 'Version');

      var params = getParams();
      var networks = [
        params["network1"],
        params["network2"],
        params["network3"]
      ];

      // Add a column for each network.
      for (var i = 0; i < networks.length; i++) {
        graph_data.addColumn('number', networks_map[networks[i]]);
      }

      // Sort the versions logically.
      var versions = data.filters.versions;
      versions = versions.sort(function(a, b) {
        if (a == b) return 0;
        a = a[0].split(" ")[1];  // Trim leading "Chrome "
        b = b[0].split(" ")[1];  // Trim leading "Chrome "
        a = a.split(".");
        b = b.split(".");
        for (var i = 0; i < a.length && i < b.length; i++) {
          if (a[i] == b[i]) continue;
          return parseInt(a[i]) - parseInt(b[i]);
        }
        return 0;
      });

      // Populate the graph data.
      for (var i = 0; i < versions.length; ++i) {
        var row = [versions[i][0].split(" ")[1]];  // Trim leading "Chrome ".
        for (var j = 0; j < networks.length; ++j) {
          var versionMap = getVersionMap(results, networks[j]);
          var point = versionMap[versions[i][1]];
          if (!point || !point.avg) {
            row.push(undefined);
          } else {
            row.push(Math.round(point.avg));
          }
        }
        graph_data.addRow(row);
      }

      var chart_div = document.getElementById('chart_div');
      if (graph_data.getNumberOfRows()) {
        var chart = new google.visualization.LineChart(chart_div);
        chart.draw(graph_data, {
          width: 800,
          height: 400,
          title: 'Click point for details',
          legend: 'bottom',
          vAxis: {
            minValue: 0,
            title: "Page Load Time (ms)",
          },
          hAxis: {
            title: "Version",
          },
        });
        google.visualization.events.addListener(chart, 'select', function() {
          var row = chart.getSelection()[0].row;
          var col = chart.getSelection()[0].column;
          var url = ("/search.html" +
                     "#version=" + getId("versions", "Chrome " + graph_data.getValue(row, 0)) +
                     "&network=" + getId("networks", graph_data.getColumnLabel(col)));
          window.location.href = url;
        });
      } else {
        chart_div.innerHTML = "No data";
      }
    }

    function filterChanged() {
      var params = {};
      var networksFilter1 = getSelectValue("networks_filter1");
      if (networksFilter1) params["network1"] = networksFilter1;
      var networksFilter2 = getSelectValue("networks_filter2");
      if (networksFilter2) params["network2"] = networksFilter2;
      var networksFilter3 = getSelectValue("networks_filter3");
      if (networksFilter3) params["network3"] = networksFilter3;
      setParams(params);
      loadData();
    }

    function main() {
      loadFilters();
    }

    </script>

    <div id='chart_div' style='width: 800px; height: 400px;'></div>

    <div id="filters_template">
    <table class="sortable">
      <tr>
        <td>Network 1</td>
        <td>Network 2</td>
        <td>Network 3</td>
      </tr>
      <tr>
        <td>
          <select id="networks_filter1" onchange="filterChanged()">
            <option jsselect="networks" jscontent="$this[0]"
                    jsvalues=".value:$this[1]"></option>
          </select>
        </td>
        <td>
          <select id="networks_filter2" onchange="filterChanged()">
            <option jsselect="networks" jscontent="$this[0]"
                    jsvalues=".value:$this[1]"></option>
          </select>
        </td>
        <td>
          <select id="networks_filter3" onchange="filterChanged()">
            <option jsselect="networks" jscontent="$this[0]"
                    jsvalues=".value:$this[1]"></option>
          </select>
        </td>
      </tr>
    </table>
    </div>

  </body>
</html>
